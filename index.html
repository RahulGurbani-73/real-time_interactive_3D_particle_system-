<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Gesture Visualizer</title>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* Cinematic Overlay */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, #000 100%);
            pointer-events: none; z-index: 2;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            z-index: 10; pointer-events: none; /* Let clicks pass through to 3D scene if needed */
        }

        /* Control Container */
        .control-group {
            pointer-events: auto;
            background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(15px);
            padding: 10px 20px; border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex; gap: 10px; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Buttons */
        .btn {
            background: transparent; border: none; color: rgba(255,255,255,0.7);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; 
            font-weight: 600; font-size: 12px; letter-spacing: 1px; text-transform: uppercase;
            transition: all 0.3s; border: 1px solid transparent;
        }
        .btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .btn.active { background: white; color: black; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        
        /* Audio Button Special Style */
        .btn-audio { border: 1px solid #00ffff; color: #00ffff; }
        .btn-audio:hover { background: #00ffff; color: black; }
        .btn-audio.active { background: #00ffff; color: black; box-shadow: 0 0 20px #00ffff; }

        /* Color Dots */
        .color-dot {
            width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3); transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.3); border-color: white; }

        /* Loading & Debug */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 50;
            color: white; transition: opacity 0.8s;
        }
        .input_video { display: none; }
        #cam-preview {
            position: absolute; top: 20px; right: 20px; width: 120px; 
            opacity: 0.4; z-index: 5; border-radius: 8px; border: 1px solid #444;
            transform: scaleX(-1);
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader">
        <h1 style="font-weight: 300; letter-spacing: 5px;">NEBULA ENGINE</h1>
        <div id="status" style="color: #00ffff; font-size: 14px; margin-top: 10px;">Initializing Core...</div>
    </div>

    <div id="vignette"></div>
    <video class="input_video" playsinline></video>
    <canvas id="cam-preview"></canvas>
    
    <div id="ui-layer">
        <!-- Audio Toggle -->
        <div class="control-group">
            <button id="audioBtn" class="btn btn-audio" onclick="toggleAudio()">ðŸŽµ Enable Audio Reactivity</button>
        </div>

        <!-- Color Themes -->
        <div class="control-group" style="padding: 8px 15px;">
            <div class="color-dot" style="background: linear-gradient(45deg, #ffaa00, #ff0000);" onclick="setTheme('fire')"></div>
            <div class="color-dot" style="background: linear-gradient(45deg, #00ffff, #0055ff);" onclick="setTheme('ice')"></div>
            <div class="color-dot" style="background: linear-gradient(45deg, #55ff00, #00aa55);" onclick="setTheme('nature')"></div>
            <div class="color-dot" style="background: linear-gradient(45deg, #ff00cc, #aa00ff);" onclick="setTheme('cyber')"></div>
            <div class="color-dot" style="background: linear-gradient(45deg, #ffffff, #ffaa00);" onclick="setTheme('gold')"></div>
        </div>

        <!-- Shapes -->
        <div class="control-group">
            <button class="btn active" onclick="setShape('saturn')">Saturn</button>
            <button class="btn" onclick="setShape('galaxy')">Galaxy</button>
            <button class="btn" onclick="setShape('sphere')">Sphere</button>
            <button class="btn" onclick="setShape('nebula')">Nebula</button>
            <button class="btn" onclick="setShape('warp')">Warp</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const statusEl = document.getElementById('status');

        // --- CONFIG ---
        const CONFIG = {
            count: 35000,
            starCount: 2000,
            size: 0.06
        };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 8;
        
        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // --- BLOOM EFFECT ---
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.1;
        bloomPass.strength = 1.6; // High bloom for neon look
        bloomPass.radius = 0.6;
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        // --- AUDIO ANALYZER SETUP ---
        let audioContext, analyser, dataArray;
        let isAudioActive = false;
        let audioLevel = 0; // 0.0 to 1.0

        window.toggleAudio = async () => {
            const btn = document.getElementById('audioBtn');
            if(!isAudioActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 64; // Low res for performance
                    source.connect(analyser);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    
                    isAudioActive = true;
                    btn.classList.add('active');
                    btn.innerText = "Listening...";
                } catch(e) {
                    alert("Microphone access denied. Audio features disabled.");
                }
            }
        };

        // --- MAIN PARTICLE SYSTEM ---
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(CONFIG.count * 3);
        const targetPositions = new Float32Array(CONFIG.count * 3);
        const velocities = new Float32Array(CONFIG.count * 3);
        const colors = new Float32Array(CONFIG.count * 3);
        const randoms = new Float32Array(CONFIG.count); // For turbulence

        // Initial Layout
        for(let i=0; i<CONFIG.count; i++) {
            positions[i*3] = (Math.random()-0.5)*20;
            positions[i*3+1] = (Math.random()-0.5)*20;
            positions[i*3+2] = (Math.random()-0.5)*20;
            targetPositions[i*3] = positions[i*3];
            colors[i*3] = 1;
            randoms[i] = Math.random();
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        geometry.setAttribute('aRandom', new THREE.BufferAttribute(randoms, 1));

        // Sparkle Texture
        const getTexture = () => {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            // Draw a star/spark
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,1)');
            g.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            g.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        };

        const material = new THREE.PointsMaterial({
            size: CONFIG.size, map: getTexture(), vertexColors: true,
            blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.9
        });

        const particleSystem = new THREE.Points(geometry, material);
        scene.add(particleSystem);

        // --- BACKGROUND STARS (DEPTH) ---
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(CONFIG.starCount * 3);
        for(let i=0; i<CONFIG.starCount*3; i++) {
            starPos[i] = (Math.random()-0.5) * 80; // Widespread
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({ color: 0x444444, size: 0.15, transparent: true });
        const starSystem = new THREE.Points(starGeo, starMat);
        scene.add(starSystem);

        // --- INTERACTION STATE ---
        let mouseX = 0, mouseY = 0;
        let targetHot = new THREE.Color(0xffaa00);
        let targetCold = new THREE.Color(0xff0000);
        let curHot = targetHot.clone();
        let curCold = targetCold.clone();
        let handDist = 0;

        // --- SHAPE GENERATOR ---
        window.setShape = (type) => {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');

            let idx = 0;
            for(let i=0; i<CONFIG.count; i++) {
                let x,y,z;
                if(type === 'saturn') {
                    const r = Math.random();
                    if(r<0.6) { // Planet
                        const theta=Math.random()*Math.PI*2, phi=Math.acos(2*Math.random()-1), rad=2.5;
                        x=rad*Math.sin(phi)*Math.cos(theta); y=rad*Math.sin(phi)*Math.sin(theta); z=rad*Math.cos(phi);
                    } else { // Ring
                        const ang=Math.random()*Math.PI*2, rad=3.5+Math.random()*2.5;
                        x=Math.cos(ang)*rad; z=Math.sin(ang)*rad; y=(Math.random()-0.5)*0.2;
                    }
                    const tx=x; x=tx*Math.cos(0.4)-y*Math.sin(0.4); y=tx*Math.sin(0.4)+y*Math.cos(0.4);
                } 
                else if (type === 'galaxy') {
                    const spin = i*0.0005, r=Math.random()*7, angle=spin+(i%3 * 2.09);
                    x=Math.cos(angle)*r; z=Math.sin(angle)*r; y=(Math.random()-0.5)*(1-r/6);
                } 
                else if (type === 'sphere') {
                    const theta=Math.random()*6.28, phi=Math.acos(2*Math.random()-1), r=3.5;
                    x=r*Math.sin(phi)*Math.cos(theta); y=r*Math.sin(phi)*Math.sin(theta); z=r*Math.cos(phi);
                }
                else if (type === 'nebula') {
                    const r = Math.random()*6;
                    const theta = Math.random()*6.28;
                    x=r*Math.cos(theta); y=(Math.random()-0.5)*4; z=r*Math.sin(theta);
                }
                else if (type === 'warp') {
                    x = (Math.random()-0.5)*5; y = (Math.random()-0.5)*5; z = (Math.random()-0.5)*20;
                }

                targetPositions[idx] = x; targetPositions[idx+1] = y; targetPositions[idx+2] = z;
                idx+=3;
            }
        };

        // --- COLOR THEMES ---
        const THEMES = {
            fire: { h: 0xffaa00, c: 0xff0000 },
            ice: { h: 0xffffff, c: 0x0055ff },
            nature: { h: 0xccff00, c: 0x008800 },
            cyber: { h: 0xff00cc, c: 0x00ffff },
            gold: { h: 0xffffff, c: 0xffaa00 }
        };
        window.setTheme = (n) => {
            if(THEMES[n]) { targetHot.setHex(THEMES[n].h); targetCold.setHex(THEMES[n].c); }
        };

        // Initialize
        window.setShape('saturn');
        
        // --- EVENT LISTENERS ---
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth/2) * 0.001;
            mouseY = (e.clientY - window.innerHeight/2) * 0.001;
        });

        document.addEventListener('touchmove', (e) => {
            if(e.touches.length > 0) {
                mouseX = (e.touches[0].clientX - window.innerWidth/2) * 0.002;
            }
        });

        // --- MEDIAPIPE ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const previewCanvas = document.getElementById('cam-preview');
        const previewCtx = previewCanvas.getContext('2d');
        
        const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5});
        
        hands.onResults(results => {
            previewCtx.clearRect(0,0,120,90);
            previewCtx.drawImage(results.image, 0, 0, 120, 90);
            if(results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                const h1 = results.multiHandLandmarks[0][9];
                const h2 = results.multiHandLandmarks[1][9];
                const d = Math.sqrt((h1.x-h2.x)**2 + (h1.y-h2.y)**2);
                handDist += (d - handDist) * 0.1;
            } else {
                handDist += (0.2 - handDist) * 0.05;
            }
        });

        const cameraUtils = new window.Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        
        cameraUtils.start().then(() => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display='none', 800);
        });

        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // 1. Audio Processing
            let beatScale = 1.0;
            if(isAudioActive && analyser) {
                analyser.getByteFrequencyData(dataArray);
                // Average low frequencies for bass
                let sum = 0;
                for(let i=0; i<10; i++) sum += dataArray[i];
                audioLevel = sum / 10 / 255; // 0 to 1
                beatScale = 1.0 + (audioLevel * 0.5); // Pulse effect
            }

            // 2. Color Transition
            curHot.lerp(targetHot, 0.05);
            curCold.lerp(targetCold, 0.05);

            // 3. Scene Rotation (Mouse + Hand + Auto)
            particleSystem.rotation.y += 0.002; // Auto rotate
            particleSystem.rotation.y += mouseX * 0.05;
            particleSystem.rotation.x += mouseY * 0.05;
            
            starSystem.rotation.y -= 0.0005; // Stars move opposite

            // 4. Global Scale (Hand + Audio Pulse)
            const targetScale = (0.5 + (handDist * 4.0)) * beatScale;
            particleSystem.scale.setScalar(targetScale);

            // 5. Particle Physics
            const pos = geometry.attributes.position.array;
            const col = geometry.attributes.color.array;
            
            for(let i=0; i<CONFIG.count; i++) {
                const idx = i*3;

                // Move to target
                velocities[idx] += (targetPositions[idx] - pos[idx]) * 0.02;
                velocities[idx+1] += (targetPositions[idx+1] - pos[idx+1]) * 0.02;
                velocities[idx+2] += (targetPositions[idx+2] - pos[idx+2]) * 0.02;

                // Add Turbulence (Noise) - Makes it look like fluid
                velocities[idx] += Math.sin(time + pos[idx+1]) * 0.002;
                velocities[idx+1] += Math.cos(time + pos[idx]) * 0.002;

                // Friction
                velocities[idx] *= 0.92;
                velocities[idx+1] *= 0.92;
                velocities[idx+2] *= 0.92;

                pos[idx] += velocities[idx];
                pos[idx+1] += velocities[idx+1];
                pos[idx+2] += velocities[idx+2];

                // Coloring
                const d = Math.sqrt(pos[idx]**2 + pos[idx+1]**2 + pos[idx+2]**2) / 6;
                const a = Math.max(0, 1 - d);
                
                // Audio boosts brightness
                const brightness = 1.0 + (audioLevel * 2.0); 
                
                col[idx] = (curHot.r * a + curCold.r * (1-a)) * brightness;
                col[idx+1] = (curHot.g * a + curCold.g * (1-a)) * brightness;
                col[idx+2] = (curHot.b * a + curCold.b * (1-a)) * brightness;
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;

            composer.render();
        }

        animate();
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
